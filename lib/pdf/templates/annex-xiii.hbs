<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EU MDR Annex XIII - {{worksheetNumber}}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', 'Helvetica', sans-serif;
      font-size: 8pt;
      color: #333;
      padding: 15px 30px;
      background: #fff;
    }

    /* Brand Colors */
    .brand-blue { color: #007289; }
    .brand-orange { color: #D2804D; }
    .bg-brand-blue { background-color: #e0f2f7; }
    .bg-brand-orange { background-color: #fef3e7; }

    /* Header Section - 2 Column Layout (30-70) */
    .header {
      display: grid;
      grid-template-columns: 30% 70%;
      gap: 20px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #007289;
      align-items: start;
    }

    .header-left {
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
    }

    .logo {
      max-width: 100%;
      max-height: 70px;
      width: auto;
      height: auto;
    }

    .header-right {
      text-align: right;
      font-size: 7pt;
      line-height: 1.3;
      color: #333;
    }

    /* Document Title */
    .document-title {
      text-align: center;
      margin-bottom: 20px;
    }

    .document-title h1 {
      font-size: 16pt;
      color: #007289;
      margin-bottom: 5px;
      font-weight: 700;
    }

    .document-title h2 {
      font-size: 11pt;
      color: #64748b;
      font-weight: 400;
      margin-bottom: 10px;
    }

    .document-number {
      font-size: 9pt;
      color: #333;
      font-weight: 600;
    }

    /* Sections */
    section {
      margin-bottom: 12px;
      page-break-inside: avoid;
    }

    section.bg-brand-blue,
    section.bg-brand-orange {
      padding: 8px;
      border-radius: 4px;
    }

    /* 50-50 Grid Layout */
    .grid-50-50 {
      display: grid;
      grid-template-columns: 50% 50%;
      gap: 15px;
      align-items: start;
    }

    .grid-column {
      width: 100%;
    }

    section h3 {
      font-size: 9pt;
      color: #007289;
      border-bottom: 1.5px solid #007289;
      padding-bottom: 3px;
      margin-bottom: 6px;
      font-weight: 600;
    }

    /* Info Tables */
    .info-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 8px;
    }

    .info-table tr {
      border-bottom: 1px solid #e2e8f0;
    }

    .info-table td {
      padding: 4px 6px;
      font-size: 7.5pt;
      line-height: 1.3;
    }

    .info-table td:first-child {
      font-weight: 600;
      color: #475569;
      width: 35%;
    }

    .info-table td:last-child {
      color: #1e293b;
    }

    /* Products & Materials Table */
    .products-materials-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 7pt;
    }

    .products-materials-table thead {
      background: #007289;
      color: white;
    }

    .products-materials-table th {
      padding: 5px 4px;
      text-align: left;
      font-weight: 600;
      font-size: 7.5pt;
      border: 1px solid #005666;
    }

    .products-materials-table th.right {
      text-align: right;
    }

    .products-materials-table th.center {
      text-align: center;
    }

    /* Product Rows */
    .product-row {
      background: #f0f7f9;
      font-weight: 600;
      color: #007289;
    }

    .product-row td {
      padding: 5px 4px;
      border: 1px solid #ddd;
      font-size: 7.5pt;
    }

    /* Material Rows (nested under products) */
    .material-row {
      background: #fff;
    }

    .material-row td {
      padding: 4px 4px;
      border: 1px solid #ddd;
      font-size: 7pt;
    }

    .material-row td:first-child {
      padding-left: 15px; /* Indent to show nesting */
    }

    .products-materials-table tbody tr:nth-child(even) .material-row {
      background: #f8f9fa;
    }

    .products-materials-table .right {
      text-align: right;
    }

    .products-materials-table .center {
      text-align: center;
    }

    /* Badge Styles */
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 7pt;
      font-weight: 600;
    }

    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-success {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-info {
      background: #dbeafe;
      color: #1e40af;
    }

    .checkmark {
      color: #16a34a;
      font-weight: bold;
      font-size: 9pt;
    }

    .dash {
      color: #94a3b8;
    }

    /* Declaration Box */
    .declaration {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 12px;
      margin: 15px 0;
      font-size: 8pt;
      line-height: 1.6;
    }

    .declaration p {
      margin-bottom: 10px;
    }

    .declaration ul {
      margin-left: 20px;
      margin-top: 10px;
    }

    .declaration strong {
      color: #92400e;
    }

    /* Compliance Box */
    .compliance-box {
      background: #e0f2fe;
      border-left: 4px solid #0284c7;
      padding: 12px;
      margin: 15px 0;
      font-size: 8pt;
      line-height: 1.6;
    }

    .compliance-box p {
      margin-bottom: 8px;
    }

    .compliance-box strong {
      color: #075985;
    }

    /* Retention Notice */
    .retention-notice {
      background: #fee2e2;
      border-left: 4px solid #dc2626;
      padding: 10px;
      margin: 20px 0;
      font-size: 9pt;
      color: #991b1b;
      font-weight: 600;
    }

    /* Signatures */
    .signatures {
      margin-top: 30px;
      display: flex;
      justify-content: space-between;
      page-break-inside: avoid;
    }

    .signature-block {
      width: 45%;
      text-align: center;
    }

    .signature-line {
      margin-top: 40px;
      border-top: 2px solid #1e293b;
      padding-top: 5px;
      font-size: 8pt;
    }

    .signature-block p {
      margin: 5px 0;
      font-size: 9pt;
    }

    .signature-block .title {
      font-weight: 600;
      color: #007289;
    }

    /* Footer - Same as Invoice */
    .footer {
      margin-top: 30px;
      padding-top: 15px;
      border-top: 1px solid #ddd;
      font-size: 8pt;
      color: #333;
      line-height: 1.5;
    }

    /* Bottom Footer - Same as Invoice */
    .bottom-footer {
      margin-top: 20px;
      padding-top: 12px;
      border-top: 2px solid #007289;
      font-size: 7pt;
      text-align: center;
      color: #333;
      line-height: 1.6;
    }

    /* Utilities */
    .bold { font-weight: bold; }
    .text-right { text-align: right; }
    .mt-10 { margin-top: 10px; }
    .mt-20 { margin-top: 20px; }

    /* Print Styles */
    @media print {
      body {
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
      }

      section {
        page-break-inside: avoid;
      }
    }

    /* Pagination */
    @page {
      @bottom-right {
        content: counter(page) " / " counter(pages);
        font-size: 8pt;
        color: #666;
        font-family: 'Arial', sans-serif;
      }
    }
  </style>
</head>
<body>
  <!-- Header Section - 2 Column Layout (30-70) -->
  <div class="header">
    <!-- Left: Logo (30%) -->
    <div class="header-left">
      {{#if lab.logoPath}}
      <img src="{{lab.logoPath}}" alt="{{lab.laboratoryName}}" class="logo">
      {{/if}}
    </div>

    <!-- Right: EU MDR Document Info (70%) -->
    <div class="header-right">
      <div style="font-size: 8pt; font-weight: 700; color: #007289; margin-bottom: 2px;">
        EU MDR ANNEX XIII - Manufacturer's Statement for Custom-Made Devices
      </div>
      <div style="font-size: 9pt; font-weight: 700; color: #D2804D; margin-bottom: 2px;">
        {{documentId}}
      </div>
      <div style="font-size: 6pt; color: #666;">
        Document Number | Generated: {{generationDate}}
      </div>
    </div>
  </div>

  <!-- Sections 1 & 2: Device Identification + Manufacturer Information (50-50 Grid) -->
  <div class="grid-50-50">
    <!-- Left Column: Section 1 - Device Identification -->
    <div class="grid-column">
      <section>
        <h3>1. Device Identification</h3>
        <table class="info-table">
          <tr>
            <td>Worksheet Number:</td>
            <td><strong>{{worksheetNumber}}</strong></td>
          </tr>
          {{#if orderNumber}}
          <tr>
            <td>Order Number:</td>
            <td>{{orderNumber}}</td>
          </tr>
          {{/if}}
          <tr>
            <td>Device Description:</td>
            <td>{{deviceDescription}}</td>
          </tr>
          <tr>
            <td>Intended Use:</td>
            <td>{{intendedUse}}</td>
          </tr>
          <tr>
            <td>Manufacture Date:</td>
            <td>{{manufactureDate}}</td>
          </tr>
          {{#if deliveryDate}}
          <tr>
            <td>Delivery Date:</td>
            <td>{{deliveryDate}}</td>
          </tr>
          {{/if}}
          <tr>
            <td>Patient:</td>
            <td>{{patientName}}</td>
          </tr>
        </table>
      </section>
    </div>

    <!-- Right Column: Section 2 - Manufacturer Information -->
    <div class="grid-column">
      <section>
        <h3>2. Manufacturer Information</h3>
        <table class="info-table">
          <tr>
            <td>Manufacturer Name:</td>
            <td><strong>{{lab.laboratoryName}}</strong></td>
          </tr>
          {{#if lab.laboratoryId}}
          <tr>
            <td>Laboratory ID:</td>
            <td>{{lab.laboratoryId}}</td>
          </tr>
          {{/if}}
          {{#if lab.laboratoryLicense}}
          <tr>
            <td>Laboratory License:</td>
            <td>{{lab.laboratoryLicense}}</td>
          </tr>
          {{/if}}
          {{#if lab.registrationNumber}}
          <tr>
            <td>Registration Number:</td>
            <td>{{lab.registrationNumber}}</td>
          </tr>
          {{/if}}
          <tr>
            <td>Address:</td>
            <td>{{lab.street}}, {{lab.postalCode}} {{lab.city}}, {{lab.country}}</td>
          </tr>
          <tr>
            <td>Contact:</td>
            <td>{{lab.email}} / {{lab.phone}}</td>
          </tr>
        </table>
      </section>
    </div>
  </div>

  <!-- Section 3: Device Classification (EU MDR Fields) -->
  <section>
    <h3>3. Device Classification</h3>
    <table class="info-table">
      <tr>
        <td>EMDN Code:</td>
        <td><strong>{{qcInspection.emdnCode}}</strong></td>
      </tr>
      <tr>
        <td>Risk Class:</td>
        <td><span class="badge badge-info">{{qcInspection.riskClass}}</span></td>
      </tr>
    </table>
  </section>

  <!-- Section 4: Prescriber Information -->
  <section>
    <h3>4. Prescriber Information</h3>
    <table class="info-table">
      <tr>
        <td>Dentist Name:</td>
        <td><strong>{{dentist.name}}</strong></td>
      </tr>
      {{#if dentist.licenseNumber}}
      <tr>
        <td>License Number:</td>
        <td>{{dentist.licenseNumber}}</td>
      </tr>
      {{/if}}
      <tr>
        <td>Clinic Name:</td>
        <td>{{dentist.clinicName}}</td>
      </tr>
      {{#if dentist.address}}
      <tr>
        <td>Clinic Address:</td>
        <td>{{dentist.address}}, {{dentist.postalCode}} {{dentist.city}}</td>
      </tr>
      {{/if}}
      <tr>
        <td>Contact:</td>
        <td>{{dentist.email}} / {{dentist.phone}}</td>
      </tr>
    </table>
  </section>

  <!-- Section 5: Products & Material Traceability (CRITICAL) -->
  <section>
    <h3>5. Products & Material Traceability</h3>
    <p style="margin-bottom: 10px; font-size: 8pt; color: #475569;">
      Complete list of all products manufactured and materials used, including LOT numbers for full traceability as required by EU MDR.
    </p>
    <table class="products-materials-table">
      <thead>
        <tr>
          <th style="width: 12%;">Code/LOT</th>
          <th style="width: 16%;">Name</th>
          <th style="width: 14%;">Manufacturer</th>
          <th class="center" style="width: 8%;">Qty</th>
          <th style="width: 10%;">Expiry</th>
          <th class="center" style="width: 8%;">Tooth</th>
          <th class="center" style="width: 5%;">CE</th>
          <th class="center" style="width: 7%;">Bio</th>
        </tr>
      </thead>
      <tbody>
        {{#each products}}
        <!-- Product Header Row -->
        <tr class="product-row">
          <td colspan="8">
            <strong>üì¶ PRODUCT:</strong> {{code}} - {{name}} (Qty: {{quantity}}) | Teeth: {{teeth}}
          </td>
        </tr>

        <!-- Materials for this Product -->
        {{#each ../materials}}
          {{#if (eq productName ../name)}}
          <tr class="material-row">
            <td>
              {{code}}<br>
              {{#if lotNumber}}
                <strong style="font-size: 7pt;">LOT: {{lotNumber}}</strong>
              {{else}}
                <span class="badge badge-warning">No LOT</span>
              {{/if}}
            </td>
            <td>{{name}}</td>
            <td>{{manufacturer}}</td>
            <td class="center">{{quantityUsed}} {{unit}}</td>
            <td>{{#if expiryDate}}{{expiryDate}}{{else}}-{{/if}}</td>
            <td class="center">{{#if toothNumber}}{{toothNumber}}{{else}}-{{/if}}</td>
            <td class="center">
              {{#if ceMarking}}
                <span class="checkmark">‚úì</span>
              {{else}}
                <span class="dash">‚Äî</span>
              {{/if}}
            </td>
            <td class="center">
              {{#if biocompatible}}
                <span class="checkmark">‚úì</span>
              {{else}}
                <span class="dash">‚Äî</span>
              {{/if}}
            </td>
          </tr>
          {{/if}}
        {{/each}}
        {{/each}}

        <!-- General Materials (not tied to specific products) -->
        {{#if (hasGeneralMaterials materials)}}
        <tr class="product-row">
          <td colspan="8">
            <strong>üîß GENERAL MATERIALS</strong> (Not product-specific)
          </td>
        </tr>
        {{#each materials}}
          {{#if (eq productName "General")}}
          <tr class="material-row">
            <td>
              {{code}}<br>
              {{#if lotNumber}}
                <strong style="font-size: 7pt;">LOT: {{lotNumber}}</strong>
              {{else}}
                <span class="badge badge-warning">No LOT</span>
              {{/if}}
            </td>
            <td>{{name}}</td>
            <td>{{manufacturer}}</td>
            <td class="center">{{quantityUsed}} {{unit}}</td>
            <td>{{#if expiryDate}}{{expiryDate}}{{else}}-{{/if}}</td>
            <td class="center">-</td>
            <td class="center">
              {{#if ceMarking}}
                <span class="checkmark">‚úì</span>
              {{else}}
                <span class="dash">‚Äî</span>
              {{/if}}
            </td>
            <td class="center">
              {{#if biocompatible}}
                <span class="checkmark">‚úì</span>
              {{else}}
                <span class="dash">‚Äî</span>
              {{/if}}
            </td>
          </tr>
          {{/if}}
        {{/each}}
        {{/if}}
      </tbody>
    </table>
  </section>

  <!-- Section 6: Annex I Compliance -->
  <section class="bg-brand-blue">
    <h3>6. Annex I Compliance</h3>
    {{#if qcInspection.annexIDeviations}}
    <div>
      <p><strong>Deviations from Annex I Requirements:</strong></p>
      <p>{{qcInspection.annexIDeviations}}</p>
    </div>
    {{else}}
    <div>
      <p><strong>‚úì FULL COMPLIANCE</strong></p>
      <p>This device fully complies with all Annex I general safety and performance requirements of EU MDR 2017/745. No deviations recorded.</p>
    </div>
    {{/if}}
  </section>

  <!-- Section 7: Declaration of Conformity -->
  <section class="bg-brand-orange">
    <h3>7. Declaration of Conformity</h3>
    <div>
      <p>
        We, <strong>{{lab.laboratoryName}}</strong>, hereby declare that the custom-made dental device
        described in this document has been manufactured in accordance with:
      </p>
      <ul>
        <li>Regulation (EU) 2017/745 (Medical Device Regulation)</li>
        <li>Annex XIII requirements for custom-made devices</li>
        <li>ISO 10993 Biocompatibility standards</li>
        <li>Applicable harmonized standards and technical specifications</li>
      </ul>
      <p style="margin-top: 15px;">
        <strong>ISO 10993 Biocompatibility:</strong> All materials used in this device comply with
        ISO 10993 standards for biological evaluation of medical devices.
      </p>
      <p>
        <strong>CE Marking:</strong> All materials used are CE marked where applicable, ensuring
        compliance with EU safety and performance requirements.
      </p>
      <p style="margin-top: 15px;">
        This device has been manufactured specifically for the patient identified in this statement
        and is intended solely for use by that patient. The device meets the essential safety and
        performance requirements applicable to it.
      </p>
    </div>
  </section>

  <!-- Section 8: Quality Control & Authorization (50-50 Grid) -->
  {{#if qcInspection}}
  <section>
    <h3>8. Quality Control & Authorization</h3>

    <div class="grid-50-50">
      <!-- Left Column: QC Inspection -->
      <div class="grid-column">
        <h4 style="font-size: 8pt; font-weight: 600; color: #007289; margin-bottom: 6px; background-color: #f1f5f9; padding: 6px;">Quality Control Inspection</h4>
        <table class="info-table">
          <tr>
            <td>QC Inspector:</td>
            <td>{{qcInspection.inspectorName}}</td>
          </tr>
          <tr>
            <td>Inspection Date:</td>
            <td>{{qcInspection.inspectionDate}}</td>
          </tr>
          <tr>
            <td>Result:</td>
            <td><span class="badge badge-success">{{qcInspection.result}}</span></td>
          </tr>
          {{#if qcInspection.notes}}
          <tr>
            <td>Notes:</td>
            <td>{{qcInspection.notes}}</td>
          </tr>
          {{/if}}
        </table>
      </div>

      <!-- Right Column: Responsible Person -->
      <div class="grid-column">
        <h4 style="font-size: 8pt; font-weight: 600; color: #007289; margin-bottom: 6px; background-color: #f1f5f9; padding: 6px;">Responsible Person (EU MDR Article 15)</h4>
        <table class="info-table">
          <tr>
            <td>Responsible Person:</td>
            <td><strong>{{lab.responsiblePersonName}}</strong></td>
          </tr>
          <tr>
            <td>Title:</td>
            <td>{{lab.responsiblePersonTitle}}</td>
          </tr>
          {{#if lab.responsiblePersonLicense}}
          <tr>
            <td>License:</td>
            <td>{{lab.responsiblePersonLicense}}</td>
          </tr>
          {{/if}}
          {{#if lab.responsiblePersonEmail}}
          <tr>
            <td>Contact:</td>
            <td>{{lab.responsiblePersonEmail}} / {{lab.responsiblePersonPhone}}</td>
          </tr>
          {{/if}}
        </table>
      </div>
    </div>
  </section>
  {{/if}}

  <!-- Signature + Retention/Document Info (50-50 Grid) -->
  <div class="grid-50-50" style="margin-top: 20px;">
    <!-- Left Column: Authorized Signature -->
    <div class="grid-column">
      <div style="text-align: center; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9fafb;">
        <p style="font-weight: 600; font-size: 8pt; color: #007289; margin-bottom: 10px;">Authorized Signature - Responsible Person</p>
        {{#if lab.signaturePath}}
        <div style="margin: 15px 0;">
          <img src="{{lab.signaturePath}}" alt="Signature" style="max-width: 200px; max-height: 80px; width: auto; height: auto;">
        </div>
        {{else}}
        <div style="height: 60px;"></div>
        {{/if}}
        <div style="border-top: 2px solid #1e293b; padding-top: 5px; margin-top: 10px; font-size: 8pt;">
          {{lab.responsiblePersonName}}
        </div>
        <p style="font-size: 7.5pt; margin: 3px 0;">{{lab.responsiblePersonTitle}}</p>
        {{#if lab.responsiblePersonLicense}}
        <p style="font-size: 7pt; color: #666;">License: {{lab.responsiblePersonLicense}}</p>
        {{/if}}
        <p style="font-size: 7.5pt; margin-top: 5px;">Date: {{generationDate}}</p>
      </div>
    </div>

    <!-- Right Column: Retention + Document Metadata -->
    <div class="grid-column">
      <!-- Retention Notice -->
      <div style="background: #fee2e2; border-left: 4px solid #dc2626; padding: 10px; margin-bottom: 10px; font-size: 7.5pt; color: #991b1b; font-weight: 600;">
        ‚ö†Ô∏è RETENTION REQUIREMENT: This document must be retained until <strong>{{retentionUntil}}</strong>
        (10 years from generation date) in accordance with EU MDR Article 10(8) requirements.
      </div>

      <!-- Document Metadata -->
      <div style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9fafb; font-size: 7.5pt;">
        <p style="margin-bottom: 5px;"><strong>Document Type:</strong> EU MDR Annex XIII Manufacturer's Statement</p>
        <p style="margin-bottom: 5px;"><strong>Generated:</strong> {{generationDate}} by {{generatedBy}}</p>
        <p style="margin-bottom: 5px;"><strong>Document ID:</strong> {{documentId}}</p>
        {{#if qcInspection.documentVersion}}
        <p><strong>Version:</strong> {{qcInspection.documentVersion}}</p>
        {{/if}}
      </div>
    </div>
  </div>

  <!-- Bottom Footer - Same as Invoice -->
  <div class="bottom-footer">
    <strong>Sede≈æ podjetja:</strong> {{lab.laboratoryName}}, {{lab.street}}, {{lab.postalCode}} {{lab.city}}, {{lab.country}}<br>
    {{#if lab.registrationNumber}}<strong>Matiƒçna ≈°tevilka:</strong> {{lab.registrationNumber}} | {{/if}}
    {{#if lab.taxId}}<strong>ID za DDV:</strong> {{lab.taxId}}<br>{{/if}}
    <strong>Osnovni kapital:</strong> 7.500 EUR | <strong>Dru≈æba je vpisana pri Okro≈ænem sodi≈°ƒçu Ljubljana.</strong>
  </div>
</body>
</html>
