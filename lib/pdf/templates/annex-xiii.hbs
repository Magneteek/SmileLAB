<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EU MDR Annex XIII - {{worksheetNumber}}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', 'Helvetica', sans-serif;
      font-size: 8pt;
      color: #333;
      padding: 15px 30px;
      background: #fff;
      line-height: 1.4;
    }

    /* Brand Colors */
    .brand-blue { color: #007289; }
    .brand-orange { color: #D2804D; }
    .bg-brand-blue { background-color: #e0f2f7; }
    .bg-brand-orange { background-color: #fef3e7; }

    /* Header Section - 2 Column Layout (30-70) */
    .header {
      display: grid;
      grid-template-columns: 30% 70%;
      gap: 20px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #007289;
      align-items: start;
    }

    .header-left {
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
    }

    .logo {
      max-width: 100%;
      max-height: 70px;
      width: auto;
      height: auto;
    }

    .header-right {
      text-align: right;
      font-size: 8pt;
      line-height: 1.3;
      color: #333;
    }

    /* Document Title */
    .document-title {
      text-align: center;
      margin-bottom: 20px;
    }

    .document-title h1 {
      font-size: 17pt;
      color: #007289;
      margin-bottom: 5px;
      font-weight: 700;
    }

    .document-title h2 {
      font-size: 12pt;
      color: #64748b;
      font-weight: 400;
      margin-bottom: 10px;
    }

    .document-number {
      font-size: 10pt;
      color: #333;
      font-weight: 600;
    }

    /* Sections */
    section {
      margin-bottom: 12px;
      page-break-inside: avoid;
    }

    section.bg-brand-blue,
    section.bg-brand-orange {
      padding: 8px;
      border-radius: 4px;
    }

    /* 50-50 Grid Layout */
    .grid-50-50 {
      display: grid;
      grid-template-columns: 50% 50%;
      gap: 15px;
      align-items: start;
    }

    .grid-column {
      width: 100%;
    }

    section h3 {
      font-size: 10pt;
      color: #007289;
      border-bottom: 1.5px solid #007289;
      padding-bottom: 3px;
      margin-bottom: 6px;
      font-weight: 600;
    }

    /* Info Tables */
    .info-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 8px;
    }

    .info-table tr {
      border-bottom: 1px solid #e2e8f0;
    }

    .info-table td {
      padding: 4px 6px;
      font-size: 8pt;
      line-height: 1.3;
    }

    .info-table td:first-child {
      font-weight: 600;
      color: #475569;
      width: 35%;
    }

    .info-table td:last-child {
      color: #1e293b;
    }

    /* Products & Materials Table */
    .products-materials-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 8pt;
    }

    .products-materials-table thead {
      background: #007289;
      color: white;
    }

    .products-materials-table th {
      padding: 5px 4px;
      text-align: left;
      font-weight: 600;
      font-size: 8pt;
      border: 1px solid #005666;
    }

    .products-materials-table th.right {
      text-align: right;
    }

    .products-materials-table th.center {
      text-align: center;
    }

    /* Product Rows */
    .product-row {
      background: #f0f7f9;
      font-weight: 600;
      color: #007289;
    }

    .product-row td {
      padding: 5px 4px;
      border: 1px solid #ddd;
      font-size: 8pt;
    }

    /* Material Rows (nested under products) */
    .material-row {
      background: #fff;
    }

    .material-row td {
      padding: 4px 4px;
      border: 1px solid #ddd;
      font-size: 8pt;
    }

    .material-row td:first-child {
      padding-left: 15px; /* Indent to show nesting */
    }

    .products-materials-table tbody tr:nth-child(even) .material-row {
      background: #f8f9fa;
    }

    .products-materials-table .right {
      text-align: right;
    }

    .products-materials-table .center {
      text-align: center;
    }

    /* Badge Styles */
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 8pt;
      font-weight: 600;
    }

    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-success {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-info {
      background: #dbeafe;
      color: #1e40af;
    }

    .checkmark {
      color: #16a34a;
      font-weight: bold;
      font-size: 8pt;
    }

    .dash {
      color: #94a3b8;
    }

    /* Declaration Box */
    .declaration {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 12px;
      margin: 15px 0;
      font-size: 8pt;
      line-height: 1.6;
    }

    .declaration p {
      margin-bottom: 10px;
    }

    .declaration ul {
      margin-left: 20px;
      margin-top: 10px;
    }

    .declaration strong {
      color: #92400e;
    }

    /* Compliance Box */
    .compliance-box {
      background: #e0f2fe;
      border-left: 4px solid #0284c7;
      padding: 12px;
      margin: 15px 0;
      font-size: 8pt;
      line-height: 1.6;
    }

    .compliance-box p {
      margin-bottom: 8px;
    }

    .compliance-box strong {
      color: #075985;
    }

    /* Retention Notice */
    .retention-notice {
      background: #fee2e2;
      border-left: 4px solid #dc2626;
      padding: 10px;
      margin: 20px 0;
      font-size: 8pt;
      color: #991b1b;
      font-weight: 600;
    }

    /* Signatures */
    .signatures {
      margin-top: 30px;
      display: flex;
      justify-content: space-between;
      page-break-inside: avoid;
    }

    .signature-block {
      width: 45%;
      text-align: center;
    }

    .signature-line {
      margin-top: 40px;
      border-top: 2px solid #1e293b;
      padding-top: 5px;
      font-size: 8pt;
    }

    .signature-block p {
      margin: 5px 0;
      font-size: 8pt;
    }

    .signature-block .title {
      font-weight: 600;
      color: #007289;
    }

    /* Footer - Same as Invoice */
    .footer {
      margin-top: 30px;
      padding-top: 15px;
      border-top: 1px solid #ddd;
      font-size: 8pt;
      color: #333;
      line-height: 1.5;
    }

    /* Bottom Footer - Same as Invoice */
    .bottom-footer {
      margin-top: 20px;
      padding-top: 12px;
      border-top: 2px solid #007289;
      font-size: 8pt;
      text-align: center;
      color: #333;
      line-height: 1.6;
    }

    /* Utilities */
    .bold { font-weight: bold; }
    .text-right { text-align: right; }
    .mt-10 { margin-top: 10px; }
    .mt-20 { margin-top: 20px; }

    /* Print Styles */
    @media print {
      body {
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
      }

      section {
        page-break-inside: avoid;
      }
    }

    /* Pagination */
    @page {
      @bottom-right {
        content: counter(page) " / " counter(pages);
        font-size: 8pt;
        color: #666;
        font-family: 'Arial', sans-serif;
      }
    }
  </style>
</head>
<body>
  <!-- Header Section - 2 Column Layout (30-70) -->
  <div class="header">
    <!-- Left: Logo (30%) -->
    <div class="header-left">
      {{#if lab.logoPath}}
      <img src="{{lab.logoPath}}" alt="{{lab.laboratoryName}}" class="logo">
      {{/if}}
    </div>

    <!-- Right: EU MDR Document Info (70%) -->
    <div class="header-right">
      <div style="font-size: 10pt; font-weight: 700; color: #D2804D; margin-bottom: 2px;">
        {{documentId}}
      </div>
      <div style="color: #666;">
        {{t.documentNumberLabel}} {{generationDate}}
      </div>
    </div>
  </div>

  <!-- Document Title - Full Width -->
  <section style="text-align: center; margin-bottom: 15px;">
    <h3 style="font-size: 10pt; color: #007289; border-bottom: 1.5px solid #007289; padding-bottom: 5px; margin-bottom: 0; text-align: center;">
      {{t.documentTitle}}
    </h3>
  </section>

  <!-- Sections 1 & 2: Device Identification + Manufacturer Information (50-50 Grid) -->
  <div class="grid-50-50">
    <!-- Left Column: Section 1 - Device Identification -->
    <div class="grid-column">
      <section>
        <h3>{{t.section1Title}}</h3>
        <table class="info-table">
          <tr>
            <td>{{t.worksheetNumber}}</td>
            <td><strong>{{worksheetNumber}}</strong></td>
          </tr>
          {{#if orderNumber}}
          <tr>
            <td>{{t.orderNumber}}</td>
            <td>{{orderNumber}}</td>
          </tr>
          {{/if}}
          <tr>
            <td>{{t.deviceDescription}}</td>
            <td>{{deviceDescription}}</td>
          </tr>
          <tr>
            <td>{{t.intendedUse}}</td>
            <td>{{intendedUse}}</td>
          </tr>
          <tr>
            <td>{{t.manufactureDate}}</td>
            <td>{{manufactureDate}}</td>
          </tr>
          {{#if deliveryDate}}
          <tr>
            <td>{{t.deliveryDate}}</td>
            <td>{{deliveryDate}}</td>
          </tr>
          {{/if}}
          <tr>
            <td>{{t.patient}}</td>
            <td>{{patientName}}</td>
          </tr>
        </table>
      </section>
    </div>

    <!-- Right Column: Section 2 - Manufacturer Information -->
    <div class="grid-column">
      <section>
        <h3>{{t.section2Title}}</h3>
        <table class="info-table">
          <tr>
            <td>{{t.laboratoryName}}</td>
            <td><strong>{{lab.laboratoryName}}</strong></td>
          </tr>
          {{#if lab.laboratoryId}}
          <tr>
            <td>{{t.laboratoryId}}</td>
            <td>{{lab.laboratoryId}}</td>
          </tr>
          {{/if}}
          {{#if lab.laboratoryLicense}}
          <tr>
            <td>{{t.laboratoryLicense}}</td>
            <td>{{lab.laboratoryLicense}}</td>
          </tr>
          {{/if}}
          {{#if lab.registrationNumber}}
          <tr>
            <td>{{t.registrationNumber}}</td>
            <td>{{lab.registrationNumber}}</td>
          </tr>
          {{/if}}
          <tr>
            <td>{{t.address}}</td>
            <td>{{lab.street}}, {{lab.postalCode}} {{lab.city}}, {{lab.country}}</td>
          </tr>
          <tr>
            <td>{{t.email}} / {{t.phone}}</td>
            <td>{{lab.email}} / {{lab.phone}}</td>
          </tr>
        </table>
      </section>
    </div>
  </div>

  <!-- Sections 3 & 4: Prescriber Information + Device Classification (50-50 Grid) -->
  <div class="grid-50-50">
    <!-- Left Column: Section 3 - Prescriber Information -->
    <div class="grid-column">
      <section>
        <h3>{{t.section4Title}}</h3>
        <table class="info-table">
          <tr>
            <td>{{t.dentistName}}</td>
            <td><strong>{{dentist.name}}</strong></td>
          </tr>
          {{#if dentist.licenseNumber}}
          <tr>
            <td>{{t.dentistLicense}}</td>
            <td>{{dentist.licenseNumber}}</td>
          </tr>
          {{/if}}
          <tr>
            <td>{{t.clinicName}}</td>
            <td>{{dentist.clinicName}}</td>
          </tr>
          {{#if dentist.address}}
          <tr>
            <td>{{t.clinicAddress}}</td>
            <td>{{dentist.address}}, {{dentist.postalCode}} {{dentist.city}}</td>
          </tr>
          {{/if}}
          <tr>
            <td>{{t.dentistEmail}} / {{t.dentistPhone}}</td>
            <td>{{dentist.email}} / {{dentist.phone}}</td>
          </tr>
        </table>
      </section>
    </div>

    <!-- Right Column: Section 4 - Device Classification -->
    <div class="grid-column">
      <section>
        <h3>{{t.section3Title}}</h3>
        <table class="info-table">
          <tr>
            <td>{{t.emdnCode}}</td>
            <td><strong>{{qcInspection.emdnCode}}</strong></td>
          </tr>
          <tr>
            <td>{{t.riskClassification}}</td>
            <td><span class="badge badge-info">{{qcInspection.riskClass}}</span></td>
          </tr>
        </table>
      </section>
    </div>
  </div>

  <!-- Section 5: Products & Material Traceability (CRITICAL) -->
  <section>
    <h3>{{t.section5Title}}</h3>
    <p style="margin-bottom: 8px; color: #475569;">
      {{t.traceabilityDescription}}
    </p>
    <h4 style="font-size: 8pt; font-weight: 600; color: #007289; margin-bottom: 6px; background-color: #f1f5f9; padding: 6px;">{{t.productsTableTitle}}</h4>
    <table class="products-materials-table">
      <thead>
        <tr>
          <th style="width: 12%;">{{t.tableCodeLot}}</th>
          <th style="width: 16%;">{{t.tableName}}</th>
          <th style="width: 14%;">{{t.tableManufacturer}}</th>
          <th class="center" style="width: 8%;">{{t.tableQty}}</th>
          <th style="width: 10%;">{{t.tableExpiry}}</th>
          <th class="center" style="width: 8%;">{{t.tableTooth}}</th>
          <th class="center" style="width: 5%;">{{t.tableCE}}</th>
          <th class="center" style="width: 7%;">{{t.tableBio}}</th>
        </tr>
      </thead>
      <tbody>
        {{#each products}}
        <!-- Product Header Row -->
        <tr class="product-row">
          <td colspan="8">
            {{../t.productLabel}} {{code}} - {{name}} ({{../t.qtyLabel}} {{quantity}}) | {{../t.teethLabel}} {{teeth}}
          </td>
        </tr>

        <!-- Materials for this Product -->
        {{#each ../materials}}
          {{#if (eq productName ../name)}}
          <tr class="material-row">
            <td>
              {{code}}<br>
              {{#if lotNumber}}
                <strong>{{../../t.lotLabel}} {{lotNumber}}</strong>
              {{else}}
                <span class="badge badge-warning">{{../../t.noLot}}</span>
              {{/if}}
            </td>
            <td>{{name}}</td>
            <td>{{manufacturer}}</td>
            <td class="center">{{quantityUsed}} {{unit}}</td>
            <td>{{#if expiryDate}}{{expiryDate}}{{else}}-{{/if}}</td>
            <td class="center">{{#if toothNumber}}{{toothNumber}}{{else}}-{{/if}}</td>
            <td class="center">
              {{#if ceMarking}}
                <span class="checkmark">✓</span>
              {{else}}
                <span class="dash">—</span>
              {{/if}}
            </td>
            <td class="center">
              {{#if biocompatible}}
                <span class="checkmark">✓</span>
              {{else}}
                <span class="dash">—</span>
              {{/if}}
            </td>
          </tr>
          {{/if}}
        {{/each}}
        {{/each}}

        <!-- General Materials (not tied to specific products) -->
        {{#if (hasGeneralMaterials materials)}}
        <tr class="product-row">
          <td colspan="8">
            {{t.generalMaterials}} ({{t.generalMaterialsDesc}})
          </td>
        </tr>
        {{#each materials}}
          {{#if (eq productName "General")}}
          <tr class="material-row">
            <td>
              {{code}}<br>
              {{#if lotNumber}}
                <strong>{{../t.lotLabel}} {{lotNumber}}</strong>
              {{else}}
                <span class="badge badge-warning">{{../t.noLot}}</span>
              {{/if}}
            </td>
            <td>{{name}}</td>
            <td>{{manufacturer}}</td>
            <td class="center">{{quantityUsed}} {{unit}}</td>
            <td>{{#if expiryDate}}{{expiryDate}}{{else}}-{{/if}}</td>
            <td class="center">-</td>
            <td class="center">
              {{#if ceMarking}}
                <span class="checkmark">✓</span>
              {{else}}
                <span class="dash">—</span>
              {{/if}}
            </td>
            <td class="center">
              {{#if biocompatible}}
                <span class="checkmark">✓</span>
              {{else}}
                <span class="dash">—</span>
              {{/if}}
            </td>
          </tr>
          {{/if}}
        {{/each}}
        {{/if}}
      </tbody>
    </table>
  </section>

  <!-- Section 6: Annex I Compliance -->
  <section class="bg-brand-blue">
    <h3>{{t.section6Title}}</h3>
    {{#if qcInspection.annexIDeviations}}
    <div>
      <p><strong>{{t.annexIDeviationsLabel}}</strong></p>
      <p>{{qcInspection.annexIDeviations}}</p>
    </div>
    {{else}}
    <div>
      <p><strong>{{t.fullCompliance}}</strong></p>
      <p>{{t.fullComplianceText}}</p>
    </div>
    {{/if}}
  </section>

  <!-- Section 7: Declaration of Conformity -->
  <section class="bg-brand-orange">
    <h3>{{t.section7Title}}</h3>
    <div>
      <p style="margin-bottom: 8px;">{{{t.declarationIntro}}}</p>
      <ul style="margin-left: 20px; margin-bottom: 10px;">
        <li>{{{t.declarationItem1}}}</li>
        <li>{{{t.declarationItem2}}}</li>
        <li>{{{t.declarationItem3}}}</li>
        <li>{{{t.declarationItem4}}}</li>
      </ul>
      <p style="margin-bottom: 6px;"><strong>{{t.biocompatibilityLabel}}</strong> {{{t.biocompatibilityText}}}</p>
      <p style="margin-bottom: 6px;"><strong>{{t.ceMarkingLabel}}</strong> {{{t.ceMarkingText}}}</p>
      <p>{{{t.patientSpecificText}}}</p>
    </div>
  </section>

  <!-- Section 8: Quality Control & Authorization (50-50 Grid) -->
  {{#if qcInspection}}
  <section>
    <h3>{{t.section8Title}}</h3>

    <div class="grid-50-50">
      <!-- Left Column: QC Inspection -->
      <div class="grid-column">
        <h4 style="font-size: 8pt; font-weight: 600; color: #007289; margin-bottom: 6px; background-color: #f1f5f9; padding: 6px;">{{t.qcInspectionTitle}}</h4>
        <table class="info-table">
          <tr>
            <td>{{t.qcInspector}}</td>
            <td>{{qcInspection.inspectorName}}</td>
          </tr>
          <tr>
            <td>{{t.inspectionDate}}</td>
            <td>{{qcInspection.inspectionDate}}</td>
          </tr>
          <tr>
            <td>{{t.result}}</td>
            <td><span class="badge badge-success">{{qcInspection.resultTranslated}}</span></td>
          </tr>
          {{#if qcInspection.notes}}
          <tr>
            <td>{{t.notes}}</td>
            <td>{{qcInspection.notes}}</td>
          </tr>
          {{/if}}
        </table>
      </div>

      <!-- Right Column: Responsible Person -->
      <div class="grid-column">
        <h4 style="font-size: 8pt; font-weight: 600; color: #007289; margin-bottom: 6px; background-color: #f1f5f9; padding: 6px;">{{t.responsiblePersonTitle}}</h4>
        <table class="info-table">
          <tr>
            <td>{{t.responsiblePerson}}</td>
            <td><strong>{{lab.responsiblePersonName}}</strong></td>
          </tr>
          <tr>
            <td>{{t.title}}</td>
            <td>{{lab.responsiblePersonTitle}}</td>
          </tr>
          {{#if lab.responsiblePersonLicense}}
          <tr>
            <td>{{t.license}}</td>
            <td>{{lab.responsiblePersonLicense}}</td>
          </tr>
          {{/if}}
          {{#if lab.responsiblePersonEmail}}
          <tr>
            <td>{{t.email}} / {{t.phone}}</td>
            <td>{{lab.responsiblePersonEmail}} / {{lab.responsiblePersonPhone}}</td>
          </tr>
          {{/if}}
        </table>
      </div>
    </div>
  </section>
  {{/if}}

  <!-- Signature + Retention/Document Info (50-50 Grid) -->
  <div class="grid-50-50" style="margin-top: 20px;">
    <!-- Left Column: Authorized Signature -->
    <div class="grid-column">
      <div style="text-align: center; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9fafb;">
        <p style="font-weight: 600; color: #007289; margin-bottom: 10px;">{{t.signatureLabel}}</p>
        {{#if lab.signaturePath}}
        <div style="margin: 15px 0;">
          <img src="{{lab.signaturePath}}" alt="Signature" style="max-width: 200px; max-height: 80px; width: auto; height: auto;">
        </div>
        {{else}}
        <div style="height: 60px;"></div>
        {{/if}}
        <div style="border-top: 2px solid #1e293b; padding-top: 5px; margin-top: 10px;">
          {{lab.responsiblePersonName}}
        </div>
        <p style="margin: 3px 0;">{{lab.responsiblePersonTitle}}</p>
        {{#if lab.responsiblePersonLicense}}
        <p style="color: #666;">{{t.license}} {{lab.responsiblePersonLicense}}</p>
        {{/if}}
        <p style="margin-top: 5px;">{{t.dateLabel}} {{generationDate}}</p>
      </div>
    </div>

    <!-- Right Column: Retention + Document Metadata -->
    <div class="grid-column">
      <!-- Retention Notice -->
      <div style="background: #fee2e2; border-left: 4px solid #dc2626; padding: 10px; margin-bottom: 10px; color: #991b1b; font-weight: 600;">
        {{{t.retentionNotice}}}
      </div>

      <!-- Document Metadata -->
      <div style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9fafb;">
        <p style="margin-bottom: 5px;"><strong>{{t.documentType}}</strong> {{t.documentTypeValue}}</p>
        <p style="margin-bottom: 5px;"><strong>{{t.generatedLabel}}</strong> {{generationDate}} {{t.generatedBy}}</p>
        <p style="margin-bottom: 5px;"><strong>{{t.documentId}}</strong> {{documentId}}</p>
        {{#if qcInspection.documentVersion}}
        <p><strong>{{t.version}}</strong> {{qcInspection.documentVersion}}</p>
        {{/if}}
      </div>
    </div>
  </div>

  <!-- Bottom Footer - Same as Invoice -->
  <div class="bottom-footer">
    {{t.footerCompanyHeadquarters}} {{lab.laboratoryName}}, {{lab.street}}, {{lab.postalCode}} {{lab.city}}, {{lab.country}}<br>
    {{t.footerRegistrationNumber}} {{lab.registrationNumber}} | {{t.footerVatId}} {{lab.taxId}}<br>
    {{t.footerShareCapital}} {{t.footerShareCapitalValue}} | {{t.footerCourtRegistration}}
  </div>
</body>
</html>
