<!DOCTYPE html>
<html lang="{{locale}}">
<head>
  <meta charset="UTF-8">
  <title>Worksheet {{worksheetNumber}}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', 'Helvetica', sans-serif;
      font-size: 8pt;
      color: #333;
      padding: 15px 25px;
      background: #fff;
    }

    /* Brand Colors */
    .brand-blue { color: #007289; }
    .brand-orange { color: #D2804D; }
    .bg-brand-blue { background-color: #e0f2f7; }
    .bg-brand-orange { background-color: #fef3e7; }

    /* Header */
    .header {
      display: grid;
      grid-template-columns: 25% 75%;
      gap: 15px;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid #007289;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }

    .logo {
      max-width: 100%;
      max-height: 50px;
      width: auto;
      height: auto;
    }

    .header-right {
      text-align: right;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
    }

    .worksheet-info {
      text-align: right;
      font-size: 10pt;
      line-height: 1.2;
      color: #007289;
      font-weight: 700;
    }

    .worksheet-info .worksheet-id {
      font-size: 14pt;
      color: #333;
      margin-top: 2px;
    }

    .qr-code {
      max-width: 60px;
      max-height: 60px;
      flex-shrink: 0;
    }

    /* Document Title - Removed */

    /* Info Grid */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      margin-bottom: 10px;
      padding: 8px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 3px;
      font-size: 7pt;
    }

    .info-item {
      padding: 3px;
    }

    .info-label {
      font-size: 6pt;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 2px;
    }

    .info-value {
      font-size: 8pt;
      font-weight: 600;
      color: #333;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 9pt;
      font-weight: 600;
      color: white;
    }

    .badge-draft { background-color: #6c757d; }
    .badge-production { background-color: #007bff; }
    .badge-qc { background-color: #ffc107; color: #000; }
    .badge-approved { background-color: #28a745; }
    .badge-delivered { background-color: #17a2b8; }

    /* Section Headers */
    .section-header {
      font-size: 8pt;
      font-weight: 700;
      color: #007289;
      margin: 8px 0 5px 0;
      padding-bottom: 3px;
      border-bottom: 1px solid #dee2e6;
    }

    /* Main Content Grid - FDI + Selected Teeth Details */
    .main-grid {
      display: grid;
      grid-template-columns: 70% 30%;
      gap: 10px;
      margin-bottom: 10px;
    }

    /* FDI Teeth Diagram */
    .teeth-diagram {
      padding: 8px;
      background: #f8f9fa;
      border: 1px solid #007289;
      border-radius: 3px;
    }

    .teeth-container {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .teeth-row {
      display: grid;
      grid-template-columns: repeat(8, 1fr) 4px repeat(8, 1fr);
      gap: 2px;
      width: 100%;
      align-items: center;
    }

    .teeth-row > * {
      flex-shrink: 1;
      min-width: 0;
    }

    .tooth {
      aspect-ratio: 1;
      border: 0.5px solid #ced4da;
      border-radius: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 5pt;
      background: white;
      font-weight: 700;
      min-width: 0;
      flex-shrink: 1;
    }

    .tooth.selected {
      background: #D2804D;
      border-color: #D2804D;
      color: white;
    }

    .midline {
      width: 4px;
      background: #007289;
      align-self: stretch;
      margin: 0 1px;
    }

    /* Selected Teeth Details */
    .selected-teeth-list {
      padding: 8px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 3px;
      font-size: 7pt;
    }

    .tooth-detail-header {
      padding: 4px 6px;
      border-bottom: 2px solid #007289;
      line-height: 1.4;
      display: grid;
      grid-template-columns: 25% 50% 25%;
      gap: 4px;
      font-weight: 700;
      color: #007289;
      font-size: 6pt;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 2px;
    }

    .tooth-detail-item {
      padding: 4px 6px;
      border-bottom: 1px solid #e9ecef;
      line-height: 1.4;
      display: grid;
      grid-template-columns: 25% 50% 25%;
      gap: 4px;
    }

    .tooth-detail-item:last-child {
      border-bottom: none;
    }

    .tooth-detail-item:nth-child(even) {
      background: white;
    }

    /* Products & Materials - Full Width */
    .full-width-section {
      padding: 8px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 3px;
      margin-bottom: 8px;
    }

    .product-item, .detail-item {
      padding: 3px 6px;
      border-bottom: 1px solid #e9ecef;
      font-size: 7pt;
      line-height: 1.4;
    }

    .product-item:last-child, .detail-item:last-child {
      border-bottom: none;
    }

    .product-item:nth-child(even), .detail-item:nth-child(even) {
      background: white;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 5px 0;
      font-size: 7pt;
    }

    thead {
      background: #007289;
      color: white;
    }

    th {
      padding: 6px 8px;
      text-align: left;
      font-weight: 700;
      font-size: 7pt;
    }

    td {
      padding: 5px 8px;
      border-bottom: 1px solid #dee2e6;
    }

    tbody tr:nth-child(even) {
      background: #f8f9fa;
    }

    .page-break {
      page-break-after: always;
    }

    /* QC Section */
    .qc-box {
      margin: 15px 0;
      padding: 12px;
      border: 2px solid #28a745;
      border-radius: 4px;
      background: #d4edda;
    }

    .qc-box.rejected {
      border-color: #dc3545;
      background: #f8d7da;
    }

    .qc-checklist {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin: 10px 0;
    }

    .qc-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 9pt;
    }

    .checkmark {
      font-size: 12pt;
      font-weight: 700;
    }

    .checkmark.pass { color: #28a745; }
    .checkmark.fail { color: #dc3545; }

    /* Notes Box */
    .notes-box {
      margin: 5px 0;
      padding: 8px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 3px;
      font-size: 7pt;
      line-height: 1.5;
    }

    /* Handwritten Notes Section */
    .handwritten-notes {
      margin: 10px 0;
      padding: 12px;
      background: #ffffff;
      border: 2px dashed #007289;
      border-radius: 3px;
      min-height: 80px;
    }

    .handwritten-notes-label {
      font-size: 7pt;
      font-weight: 700;
      color: #007289;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .notes-label {
      font-weight: 700;
      color: #007289;
      margin-bottom: 5px;
    }

    /* Additional Information - Compact */
    .additional-info {
      margin: 8px 0;
      padding: 8px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 3px;
      font-size: 7pt;
      line-height: 1.6;
    }

    .additional-info .info-line {
      margin-bottom: 4px;
    }

    .additional-info .info-line:last-child {
      margin-bottom: 0;
    }

    .additional-info .info-label {
      font-weight: 700;
      color: #007289;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      {{#if lab.logoPath}}
        <img src="{{lab.logoPath}}" alt="{{lab.name}}" class="logo">
      {{else}}
        <div style="font-size: 14pt; font-weight: 700; color: #007289;">{{lab.name}}</div>
      {{/if}}
    </div>
    <div class="header-right">
      <div class="worksheet-info">
        Delavni nalog<br>
        <div class="worksheet-id">{{worksheetNumber}}</div>
      </div>
      {{#if qrCodeDataUrl}}
        <img src="{{qrCodeDataUrl}}" alt="QR Code" class="qr-code">
      {{/if}}
    </div>
  </div>

  <!-- Worksheet Info Grid (5 columns - 2 rows) -->
  <div class="info-grid">
    <div class="info-item">
      <div class="info-label">{{t.orderNumber}}</div>
      <div class="info-value">{{order.orderNumber}}</div>
    </div>
    <div class="info-item">
      <div class="info-label">{{t.orderDate}}</div>
      <div class="info-value">{{order.orderDate}}</div>
    </div>
    {{#if lab.laboratoryId}}
      <div class="info-item">
        <div class="info-label">{{t.laboratoryId}}</div>
        <div class="info-value">{{lab.laboratoryId}}</div>
      </div>
    {{/if}}
    <div class="info-item">
      <div class="info-label">{{t.patient}}</div>
      <div class="info-value">{{order.patientName}}</div>
    </div>
    <div class="info-item">
      <div class="info-label">{{t.dueDate}}</div>
      <div class="info-value">{{dueDate}}</div>
    </div>
    <div class="info-item">
      <div class="info-label">{{t.priority}}</div>
      <div class="info-value">{{priorityLabel}}</div>
    </div>
    <div class="info-item">
      <div class="info-label">Klinika</div>
      <div class="info-value">{{dentist.clinicName}}</div>
    </div>
    <div class="info-item">
      <div class="info-label">{{t.dentist}}</div>
      <div class="info-value">{{dentist.dentistName}}</div>
    </div>
    <div class="info-item">
      <div class="info-label">{{t.impressionType}}</div>
      <div class="info-value">{{order.impressionType}}</div>
    </div>
  </div>

  <!-- Main Grid: FDI (70%) + Additional Info (30%) -->
  <div class="main-grid">
    <!-- FDI Teeth Diagram (Left 70%) -->
    <div>
      <div class="section-header">{{t.selectedTeeth}}</div>
      <div class="teeth-diagram">
        <div class="teeth-container">
          <!-- Upper Row: 18-11 | 21-28 -->
          <div class="teeth-row upper">
            {{#each upperRight}}
              <div class="tooth {{#if this.selected}}selected{{/if}}">{{this.number}}</div>
            {{/each}}
            <div class="midline"></div>
            {{#each upperLeft}}
              <div class="tooth {{#if this.selected}}selected{{/if}}">{{this.number}}</div>
            {{/each}}
          </div>
          <!-- Lower Row: 48-41 | 31-38 -->
          <div class="teeth-row lower">
            {{#each lowerRight}}
              <div class="tooth {{#if this.selected}}selected{{/if}}">{{this.number}}</div>
            {{/each}}
            <div class="midline"></div>
            {{#each lowerLeft}}
              <div class="tooth {{#if this.selected}}selected{{/if}}">{{this.number}}</div>
            {{/each}}
          </div>
        </div>
      </div>
    </div>

    <!-- Additional Information (Right 30%) -->
    <div>
      <div class="section-header">{{t.additionalInfo}}</div>
      <div class="additional-info">
        {{#if selectedTeethDetails.length}}
          <div class="info-line">
            <span class="info-label">{{t.workType}}:</span>
            {{#each selectedTeethDetails}}{{this.workType}}{{#unless @last}}, {{/unless}}{{/each}}
          </div>
          <div class="info-line">
            <span class="info-label">{{t.shadeColor}}:</span>
            {{#each selectedTeethDetails}}{{#if this.shade}}{{this.shade}}{{#unless @last}}, {{/unless}}{{/if}}{{/each}}
          </div>
        {{/if}}
        {{#if deviceDescription}}
          <div class="info-line">
            <span class="info-label">{{t.deviceDescription}}:</span> {{deviceDescription}}
          </div>
        {{/if}}
        {{#if intendedUse}}
          <div class="info-line">
            <span class="info-label">{{t.intendedUse}}:</span> {{intendedUse}}
          </div>
        {{/if}}
        {{#if technicalNotes}}
          <div class="info-line">
            <span class="info-label">{{t.technicalNotes}}:</span> {{technicalNotes}}
          </div>
        {{/if}}
      </div>
    </div>
  </div>

  <!-- Products with Materials - Consolidated Table -->
  <div class="section-header">{{t.products}}</div>
  <table>
    <thead>
      <tr>
        <th style="width: 20%;">Izdelek</th>
        <th style="width: 20%;">Material</th>
        <th style="width: 15%;">{{t.manufacturer}}</th>
        <th style="width: 15%;">{{t.lotNumber}}</th>
        <th style="width: 10%;">{{t.quantity}}</th>
        <th style="width: 8%;">{{t.tooth}}</th>
        <th style="width: 12%;">{{t.notes}}</th>
      </tr>
    </thead>
    <tbody>
      {{#each products}}
        {{#if this.materials.length}}
          {{#each this.materials}}
            <tr>
              {{#if @first}}
                <td rowspan="{{../this.materials.length}}" style="vertical-align: top; background: #f0f9fb; border-right: 3px solid #007289;"><strong>{{../this.productName}}</strong></td>
              {{/if}}
              <td>{{this.materialName}}</td>
              <td>{{this.manufacturer}}</td>
              <td><strong>{{this.lotNumber}}</strong></td>
              <td>{{this.quantityUsed}} {{this.unit}}</td>
              <td>{{#if this.toothNumber}}{{this.toothNumber}}{{else}}-{{/if}}</td>
              <td style="font-size: 6pt;">{{#if this.notes}}{{this.notes}}{{else}}-{{/if}}</td>
            </tr>
          {{/each}}
        {{else}}
          <tr>
            <td style="background: #f0f9fb; border-right: 3px solid #007289;"><strong>{{this.productName}}</strong></td>
            <td colspan="6" style="font-style: italic; color: #6c757d;">Še ni dodeljenih materialov</td>
          </tr>
        {{/if}}
      {{/each}}
    </tbody>
  </table>

  <!-- Handwritten Notes Section -->
  <div class="handwritten-notes">
    <div class="handwritten-notes-label">Opombe / Notes</div>
    <!-- Empty space for handwritten notes -->
  </div>

  <!-- Materials with LOT Numbers -->
  {{#if materials.length}}
    <div class="section-header">{{t.materials}}</div>
    <table>
      <thead>
        <tr>
          <th>{{t.materialName}}</th>
          <th>{{t.manufacturer}}</th>
          <th>{{t.lotNumber}}</th>
          <th>{{t.quantity}}</th>
          <th>{{t.expiryDate}}</th>
        </tr>
      </thead>
      <tbody>
        {{#each materials}}
          <tr>
            <td><strong>{{this.materialName}}</strong></td>
            <td>{{this.manufacturer}}</td>
            <td><strong>{{this.lotNumber}}</strong></td>
            <td>{{this.quantity}} {{this.unit}}</td>
            <td>{{this.expiryDate}}</td>
          </tr>
        {{/each}}
      </tbody>
    </table>
  {{/if}}

  {{#if order.notes}}
    <div class="section-header">{{t.orderNotes}}</div>
    <div class="notes-box">
      {{order.notes}}
    </div>
  {{/if}}

  <!-- Quality Control -->
  {{#if qualityControl}}
    <div class="section-header">{{t.qualityControl}}</div>
    <div class="qc-box {{#if qualityControl.rejected}}rejected{{/if}}">
      <div style="margin-bottom: 10px;">
        <strong>{{t.inspector}}:</strong> {{qualityControl.inspector}}<br>
        <strong>{{t.inspectionDate}}:</strong> {{qualityControl.inspectionDate}}<br>
        <strong>{{t.result}}:</strong>
        <span class="badge {{#if qualityControl.approved}}badge-approved{{else}}badge-draft{{/if}}">
          {{qualityControl.result}}
        </span>
      </div>

      <div class="qc-checklist">
        <div class="qc-item">
          <span class="checkmark {{#if qualityControl.aesthetics}}pass{{else}}fail{{/if}}">
            {{#if qualityControl.aesthetics}}✓{{else}}✗{{/if}}
          </span>
          {{t.aesthetics}}
        </div>
        <div class="qc-item">
          <span class="checkmark {{#if qualityControl.fit}}pass{{else}}fail{{/if}}">
            {{#if qualityControl.fit}}✓{{else}}✗{{/if}}
          </span>
          {{t.fit}}
        </div>
        <div class="qc-item">
          <span class="checkmark {{#if qualityControl.occlusion}}pass{{else}}fail{{/if}}">
            {{#if qualityControl.occlusion}}✓{{else}}✗{{/if}}
          </span>
          {{t.occlusion}}
        </div>
        <div class="qc-item">
          <span class="checkmark {{#if qualityControl.shade}}pass{{else}}fail{{/if}}">
            {{#if qualityControl.shade}}✓{{else}}✗{{/if}}
          </span>
          {{t.shade}}
        </div>
        <div class="qc-item">
          <span class="checkmark {{#if qualityControl.margins}}pass{{else}}fail{{/if}}">
            {{#if qualityControl.margins}}✓{{else}}✗{{/if}}
          </span>
          {{t.margins}}
        </div>
      </div>

      {{#if qualityControl.notes}}
        <div class="notes-box">
          <div class="notes-label">{{t.notes}}:</div>
          {{qualityControl.notes}}
        </div>
      {{/if}}

      {{#if qualityControl.actionRequired}}
        <div class="notes-box">
          <div class="notes-label">{{t.actionRequired}}:</div>
          {{qualityControl.actionRequired}}
        </div>
      {{/if}}
    </div>
  {{/if}}

  <!-- MDR Compliance Statement (Full Width) -->
  <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 3px; padding: 10px; margin-bottom: 10px; font-size: 7pt; line-height: 1.4; text-align: justify;">
    {{t.complianceStatement}}
  </div>

  <!-- Manufacturer/Technician Info with Signature Space (Full Width) -->
  <div class="info-grid" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom: 10px;">
    <div class="info-item">
      <div class="info-label">{{t.manufacturerSection}}</div>
      <div class="info-value">{{technician.name}}</div>
    </div>
    {{#if technician.idNumber}}
      <div class="info-item">
        <div class="info-label">{{t.technicianIdNumber}}</div>
        <div class="info-value">{{technician.idNumber}}</div>
      </div>
    {{/if}}
    <div class="info-item">
      <div class="info-label">PODPIS / SIGNATURE</div>
      <div style="border-bottom: 1px solid #dee2e6; margin-top: 10px; height: 30px;"></div>
    </div>
  </div>

</body>
</html>
